rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if match is open
    function isMatchOpen(matchId) {
      return get(/databases/$(database)/documents/matches/$(matchId)).data.status == 'open';
    }

    // Users collection rules
    match /users/{userId} {
      // Read: authenticated users can read any user profile
      allow read: if request.auth != null;
      
      // Write: users can update their own profile, admins can update any
      allow write: if request.auth != null && (
        // User can update their own profile but only safe fields
        (request.auth.uid == userId && 
         request.resource.data.keys().hasAll(['name', 'photo']) &&
         request.resource.data.keys().size() == 2) ||
        // Admins can update any user profile
        isAdmin()
      );
      
      // Create: only admins can create users (or system during user creation)
      allow create: if request.auth != null && isAdmin();
    }

    // Matches collection rules
    match /matches/{matchId} {
      // Read: authenticated users can read matches
      allow read: if request.auth != null;
      
      // Create/Delete: only admins
      allow create, delete: if request.auth != null && isAdmin();

      // Update: any authenticated user (for closing matches)
      allow update: if request.auth != null;
    }

    // Votes collection rules (subcollection under matches)
    match /votes/{matchId}/userVotes/{userId} {
      // Read: authenticated users can read votes (for statistics)
      allow read: if request.auth != null;
      
      // Write: users can only write their own vote and only if match is open
      allow write, create: if request.auth != null && 
                          request.auth.uid == userId && 
                          isMatchOpen(matchId);
      
      // Delete: users can delete their own vote, admins can delete any
      allow delete: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );
    }
  }
}
